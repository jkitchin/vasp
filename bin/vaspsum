#!/usr/bin/env python
"""Summarize VASP calculations.

This script provides a quick summary of VASP calculations in one or more
directories. It can display results in various formats and visualize structures.
"""

import argparse
import json
import os
import sys
from pathlib import Path

from ase.visualize import view as ase_view
from vasp import Vasp
from vasp.exceptions import VaspException


def format_energy(energy, natoms):
    """Format energy output."""
    if energy is None:
        return "Energy: Not available"
    return f"Energy: {energy:.6f} eV ({energy/natoms:.6f} eV/atom)"


def format_forces(forces):
    """Format forces output."""
    if forces is None:
        return "Forces: Not available"
    fmax = (forces**2).sum(axis=1).max()**0.5
    return f"Max force: {fmax:.6f} eV/Ã…"


def format_stress(stress):
    """Format stress output."""
    if stress is None:
        return "Stress: Not available"
    # Convert to GPa (VASP stress is in kB)
    stress_gpa = stress * 0.1
    pressure = -stress_gpa[:3].mean()
    return f"Pressure: {pressure:.3f} GPa"


def print_summary(calc, verbose=False):
    """Print a summary of the calculation."""
    try:
        atoms = calc.atoms
        if atoms is None:
            print("  No structure found")
            return

        print(f"  Formula: {atoms.get_chemical_formula()}")
        print(f"  Atoms: {len(atoms)}")

        # Try to get results
        try:
            energy = calc.results.get('energy')
            forces = calc.results.get('forces')
            stress = calc.results.get('stress')

            print(f"  {format_energy(energy, len(atoms))}")
            if verbose and forces is not None:
                print(f"  {format_forces(forces)}")
            if verbose and stress is not None:
                print(f"  {format_stress(stress)}")

            # Check convergence
            converged = calc.results.get('converged', None)
            if converged is not None:
                status = "Converged" if converged else "NOT CONVERGED"
                print(f"  Status: {status}")

        except (VaspException, FileNotFoundError) as e:
            print(f"  Results not available: {e}")

    except Exception as e:
        print(f"  Error reading calculation: {e}")


def print_parameters(calc, verbose=False):
    """Print calculation parameters."""
    print("\nParameters:")
    params = calc.parameters

    # Key parameters to always show
    key_params = ['xc', 'encut', 'kpts', 'ismear', 'sigma']

    for key in key_params:
        if key in params:
            print(f"  {key}: {params[key]}")

    if verbose:
        print("\nAll parameters:")
        for key, value in sorted(params.items()):
            if key not in key_params:
                print(f"  {key}: {value}")


def print_json(calc, pretty=False):
    """Print JSON representation of results."""
    data = {
        'directory': calc.directory,
        'parameters': calc.parameters,
        'results': calc.results,
    }

    if calc.atoms:
        data['formula'] = calc.atoms.get_chemical_formula()
        data['natoms'] = len(calc.atoms)
        data['positions'] = calc.atoms.positions.tolist()
        data['cell'] = calc.atoms.cell.tolist()
        data['symbols'] = calc.atoms.get_chemical_symbols()

    if pretty:
        print(json.dumps(data, indent=2, default=str))
    else:
        print(json.dumps(data, default=str))


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description='Summarize VASP calculations',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  vaspsum                    # Summarize current directory
  vaspsum calc1 calc2        # Summarize multiple directories
  vaspsum -v .               # Verbose output
  vaspsum --json calc1       # JSON output
  vaspsum --view .           # View structure
  vaspsum --trajectory .     # View trajectory
        """
    )

    parser.add_argument(
        'dirs',
        nargs='*',
        default=['.'],
        help='Directories to summarize (default: current directory)'
    )

    parser.add_argument(
        '-v', '--verbose',
        action='store_true',
        help='Show detailed information'
    )

    parser.add_argument(
        '--params', '--describe',
        action='store_true',
        help='Show calculation parameters'
    )

    parser.add_argument(
        '--json',
        action='store_true',
        help='Output in JSON format'
    )

    parser.add_argument(
        '--json-pretty', '--jsonpp',
        action='store_true',
        help='Output in pretty-printed JSON format'
    )

    parser.add_argument(
        '--view', '-p',
        action='store_true',
        help='View final structure'
    )

    parser.add_argument(
        '--trajectory', '-t',
        action='store_true',
        help='View full trajectory'
    )

    args = parser.parse_args()

    # Process each directory
    for directory in args.dirs:
        if not os.path.isdir(directory):
            print(f"Error: {directory} does not exist!", file=sys.stderr)
            continue

        print(f"\n{directory}")
        print("=" * 60)

        try:
            # Load calculation
            calc = Vasp(directory)

            # Output in requested format
            if args.json or args.json_pretty:
                print_json(calc, pretty=args.json_pretty)
            elif args.params:
                print_summary(calc, verbose=args.verbose)
                print_parameters(calc, verbose=args.verbose)
            else:
                print_summary(calc, verbose=args.verbose)

            # Visualization
            if args.view and calc.atoms:
                ase_view(calc.atoms)

            if args.trajectory and calc.atoms:
                # Try to read trajectory
                try:
                    from ase.io import read
                    outcar = os.path.join(directory, 'OUTCAR')
                    if os.path.exists(outcar):
                        traj = read(outcar, index=':')
                        ase_view(traj)
                    else:
                        print("  Warning: OUTCAR not found for trajectory")
                        ase_view(calc.atoms)
                except Exception as e:
                    print(f"  Warning: Could not read trajectory: {e}")
                    ase_view(calc.atoms)

        except Exception as e:
            print(f"Error processing {directory}: {e}", file=sys.stderr)
            if args.verbose:
                import traceback
                traceback.print_exc()


if __name__ == '__main__':
    main()
